<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∑–≤—É–∫—É (Gemini TTS - JSON)</title>
    <script src="/env-config.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #f0f9ff; }
        button { font-size: 1.5rem; padding: 20px 40px; border-radius: 15px; border: none; background: #3b82f6; color: white; cursor: pointer; margin-bottom: 20px; }
        #log { white-space: pre-wrap; word-break: break-all; background: #fff; padding: 10px; border: 1px solid #ccc; max-height: 500px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üîä –¢–µ—Å—Ç –∑–≤—É–∫—É (Gemini 2.5 TTS)</h1>
    <button id="btn">–°–∫–∞–∑–∞—Ç–∏ "–ê"</button>
    <div id="log">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</div>

    <script type="module">
        import { GoogleGenAI } from "https://esm.sh/@google/genai@^1.41.0";

        const logDiv = document.getElementById('log');
        
        function log(msg) {
            console.log(msg);
            logDiv.innerText += msg + '\n----------------\n';
        }

        async function speak() {
            logDiv.innerText = "–ü–æ—á–∞—Ç–æ–∫ —Ç–µ—Å—Ç—É...\n";
            try {
                const apiKey = (window._env_ && window._env_.API_KEY) || '';
                log("API Key: " + (apiKey ? "–ó–Ω–∞–π–¥–µ–Ω–æ (" + apiKey.substring(0, 4) + "...)" : "–ù–ï –ó–ù–ê–ô–î–ï–ù–û!"));

                const ai = new GoogleGenAI({ apiKey });
                const modelName = "gemini-2.5-flash-preview-tts"; 

                log(`–í—ñ–¥–ø—Ä–∞–≤–ª—è—é –∑–∞–ø–∏—Ç –¥–æ –º–æ–¥–µ–ª—ñ: ${modelName}`);

                const response = await ai.models.generateContent({
                    model: modelName,
                    contents: [{ parts: [{ text: "–ê" }] }],
                    config: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: 'Kore' },
                            },
                        },
                    },
                });

                log("–í—ñ–¥–ø–æ–≤—ñ–¥—å –æ—Ç—Ä–∏–º–∞–Ω–æ. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (JSON):");
                log(JSON.stringify(response, null, 2));

                const candidate = response.candidates?.[0];
                if (!candidate) throw new Error("No candidates in response");
                
                const part = candidate.content?.parts?.[0];
                if (!part) throw new Error("No parts in candidate content");

                let base64Audio = part.inlineData?.data;
                
                if (!base64Audio) {
                    log("–£–í–ê–ì–ê: inlineData.data –≤—ñ–¥—Å—É—Ç–Ω—ñ–π. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ª–æ–≥ –≤–∏—â–µ!");
                    if (part.text) log("–ó–Ω–∞–π–¥–µ–Ω–æ —Ç–µ–∫—Å—Ç –∑–∞–º—ñ—Å—Ç—å –∞—É–¥—ñ–æ: " + part.text);
                } else {
                    log(`–ê—É–¥—ñ–æ –∑–Ω–∞–π–¥–µ–Ω–æ! –î–æ–≤–∂–∏–Ω–∞ base64: ${base64Audio.length}`);
                    
                    // Decode and Play
                    const binaryString = atob(base64Audio);
                    const len = binaryString.length;
                    const bytes = new Uint8Array(len);
                    for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);

                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const dataInt16 = new Int16Array(bytes.buffer);
                    const audioBuffer = ctx.createBuffer(1, dataInt16.length, 24000);
                    const channelData = audioBuffer.getChannelData(0);
                    for (let i = 0; i < dataInt16.length; i++) {
                        channelData[i] = dataInt16[i] / 32768.0;
                    }

                    const source = ctx.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(ctx.destination);
                    source.start();
                    log("–í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø—É—â–µ–Ω–æ!");
                }

            } catch (e) {
                log("–ü–û–ú–ò–õ–ö–ê: " + e.toString());
                console.error(e);
            }
        }

        document.getElementById('btn').addEventListener('click', speak);
    </script>
</body>
</html>
